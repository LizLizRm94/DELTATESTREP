@page "/Registro"

@using Microsoft.AspNetCore.Components.Forms
@using DELTATEST.Models
@inject DELTATEST.Services.AuthService AuthService
@layout MainSinLayout
@inject NavigationManager Navigation

<style>
    .form-container { display:flex; justify-content:center; align-items:center; height:100vh; }
    .form-box { width:420px; padding:30px; border:1px solid #e6e6e6; border-radius:8px; }
    .btn-primary { background-color:#e5a650; color:white; padding:10px; width:100%; border:none; border-radius:6px }
</style>

    <div class="form-container">
        <div class="form-box">
            <h2>Registro</h2>

            @if (isSubmitting)
            {
                <div class="text-center mb-3">
                    <div class="spinner-border text-warning" role="status"></div>
                    <p class="mt-2">Creando cuenta...</p>
                </div>
            }

            <EditForm Model="model" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-2">
                    <label>Nombre completo</label>
                    <InputText @bind-Value="model.NombreCompleto" class="form-control" />
                    <ValidationMessage For="() => model.NombreCompleto" />
                </div>

                <div class="mb-2">
                    <label>Correo</label>
                    <InputText @bind-Value="model.Correo" type="email" class="form-control" />
                    <ValidationMessage For="() => model.Correo" />
                </div>

                <div class="mb-2">
                    <label>CI (opcional)</label>
                    <InputText @bind-Value="model.Ci" class="form-control" />
                </div>

                <div class="mb-2">
                    <label>Teléfono (opcional)</label>
                    <InputText @bind-Value="model.Telefono" class="form-control" />
                </div>

                <div class="mb-2">
                    <label>Fecha de ingreso (opcional)</label>
                    <InputDate @bind-Value="model.FechaIngreso" class="form-control" />
                </div>

                <div class="mb-2">
                    <label>Rol</label>
                    <InputSelect @bind-Value="model.Rol" class="form-control">
                        <option value="">Seleccionar rol</option>
                        <option value="Inspector">Inspector</option>
                        <option value="Usuario">Usuario</option>
                    </InputSelect>
                </div>

                <div class="mb-2">
                    <label>Contraseña</label>
                    <InputText @bind-Value="model.Password" type="password" class="form-control" />
                    <ValidationMessage For="() => model.Password" />
                </div>

                <div class="mb-2">
                    <label>Confirmar contraseña</label>
                    <InputText @bind-Value="model.ConfirmPassword" type="password" class="form-control" />
                    <ValidationMessage For="() => model.ConfirmPassword" />
                </div>

                @if (!string.IsNullOrEmpty(message))
                {
                    <div class="text-danger">@message</div>
                }

                <button type="submit" class="btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span>Procesando...</span>
                    }
                    else
                    {
                        <span>Crear cuenta</span>
                    }
                </button>

            </EditForm>

            <div style="margin-top:10px">
                <a href="/IniciarSesion">¿Ya tienes cuenta? Inicia sesión</a>
            </div>
        </div>
    </div>


@code {
    private RegisterModel model = new();
    private string? message;
    private bool isSubmitting = false;

    private async Task HandleValidSubmit()
    {
        isSubmitting = true;
        message = null;
        StateHasChanged();

        var (success, rol, msg, nombre) = await AuthService.RegisterAsync(model);

        if (success)
        {
            if (string.Equals(rol, "Inspector", StringComparison.OrdinalIgnoreCase))
                Navigation.NavigateTo("/panelControlAdmin", forceLoad: true);
            else
                Navigation.NavigateTo("/", forceLoad: true);

            return;
        }

        message = msg ?? "Error al registrar.";
        isSubmitting = false;
    }
}

