@page "/EvaluacionPractica/{IdUsuario:int}/{NombreUsuario}"
@using DELTATEST.Models
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@layout MainSinLayout

<div class="container-evaluacion">
    <h3 class="titulo-evaluacion">EVALUACION PRACTICA</h3>

    @if (mostrarMensaje)
    {
       <div class="alerta @(esError ? "alerta-error" : "alerta-exito")">
          <span>@mensajeRespuesta</span>
          <button type="button" class="btn-cerrar" @onclick="CerrarMensaje">&times;</button>
       </div>
    }

    @if (!mostrarResultado)
    {
        <div class="evaluado-info">
          <p>Evaluad(a): <strong>@NombreUsuario</strong></p>
        </div>

    @if (cargando)
    {
       <div class="loading-container">
           <div class="spinner"></div>
           <p>Cargando evaluación...</p>
       </div>
    }
    else if (modelo == null || modelo.Tareas == null || modelo.Tareas.Count == 0)
    {
     <div class="alerta alerta-info">
    <span>No hay tareas disponibles para esta evaluación</span>
     </div>
      }
        else
        {
       <div class="tarea-card">
  <!-- Menú desplegable de instrumentos -->
    <div class="instrumentos-section">
        <label class="label-instrumento">Seleccione el instrumento utilizado:</label>
        <select class="select-instrumento" @bind="instrumentoSeleccionado">
          <option value="">-- Seleccionar instrumento --</option>
 <option value="Balanza Analítica Mettler Toledo MS204S/01">Balanza Analítica Mettler Toledo MS204S/01</option>
  <option value="Balanza Analítica Mettler Toledo MS204TS/00">Balanza Analítica Mettler Toledo MS204TS/00</option>
       <option value="Balanza de Precisión Mettler Toledo ICS425SF1AUM0A00B1">Balanza de Precisión Mettler Toledo ICS425SF1AUM0A00B1</option>
    <option value="Balanza de Precisión Mettler Toledo PG503">Balanza de Precisión Mettler Toledo PG503</option>
          <option value="Balanza de Humedad Mettler Toledo HC103">Balanza de Humedad Mettler Toledo HC103</option>
  <option value="Balanza de Humedad Mettler Toledo HG53">Balanza de Humedad Mettler Toledo HG53</option>
        <option value="Balanza de Humedad Mettler Toledo HB43-S HALOGEN">Balanza de Humedad Mettler Toledo HB43-S HALOGEN</option>
  <option value="Cámara de Estabilidad Thermolab TS0000400G">Cámara de Estabilidad Thermolab TS0000400G</option>
  <option value="Espectrofotómetro IR Jasco FT/IR-4700">Espectrofotómetro IR Jasco FT/IR-4700</option>
         <option value="Disolutor Hanson SR8-PLUS">Disolutor Hanson SR8-PLUS</option>
         <option value="Disolutor Hanson VISIONELITE 8">Disolutor Hanson VISIONELITE 8</option>
         <option value="pHmetro Multiparámetro METTLER TOLEDO">pHmetro Multiparámetro METTLER TOLEDO</option>
    <option value="Titulador Karl Fischer SI ANALYTICS TitroLine®7500 KF">Titulador Karl Fischer SI ANALYTICS TitroLine®7500 KF</option>
     <option value="Desintegrador PHARMA TEST PTZ - 2E">Desintegrador PHARMA TEST PTZ - 2E</option>
        </select>
    </div>

            <!-- Información de progreso -->
        <div class="progreso-section">
        <p class="contador-progreso">Tarea <strong>@(indiceActual + 1)</strong> de <strong>@modelo.Tareas.Count</strong></p>
           <div class="barra-progreso">
       <div class="barra-progreso-fill" style="width: @((indiceActual + 1) * 100 / modelo.Tareas.Count)%"></div>
     </div>
</div>

      <!-- Pregunta actual -->
      <div class="pregunta-section">
          <p class="contador-tareas">Del 1 al 10 ¿Que tal lo hizo? Califique:</p>
 </div>

     <!-- Sistema de estrellas para calificación -->
    <div class="estrellas-container">
@for (int i = 1; i <= 10; i++)
        {
   int calificacion = i;
   <button type="button" 
       class="estrella @(indiceActual < modelo.Tareas.Count && modelo.Tareas[indiceActual].Calificacion >= calificacion ? "activa" : "")"
      @onclick="() => CalificarTarea(calificacion)"
  title="@calificacion estrella(s)">
          ★
     </button>
         }
         </div>

   <!-- Campo de descripción -->
<div class="descripcion-section">
 <label class="label-descripcion">Ingrese una breve descripcion para mejorar</label>
       @if (indiceActual < modelo.Tareas.Count)
    {
     <textarea class="textarea-descripcion" 
       @bind="modelo.Tareas[indiceActual].ResultadoObtenido"
      placeholder="Ingrese su descripcion"></textarea>
 }
    </div>

  <!-- Botones de navegación -->
    <div class="botones-navegacion">
      <button type="button" 
            class="btn btn-siguiente"
     @onclick="IrASiguiente"
 disabled="@(indiceActual >= modelo.Tareas.Count - 1 || cargandoSubmit || (indiceActual < modelo.Tareas.Count && (!modelo.Tareas[indiceActual].Calificacion.HasValue || modelo.Tareas[indiceActual].Calificacion.Value <= 0)))">
        Siguiente
    </button>
     <button type="button" 
        class="btn btn-listo"
    @onclick="Finalizar"
  disabled="@cargandoSubmit">
  @if (cargandoSubmit)
 {
         <span>Guardando...</span>
   }
       else
         {
          <span>Listo</span>
     }
     </button>
 </div>
     </div>
    }
    }
</div>

<style>
    .container-evaluacion {
        max-width: 900px;
        margin: 0 auto;
    padding: 40px 20px;
        background: white;
        min-height: 100vh;
 }

    .titulo-evaluacion {
        text-align: left;
      font-size: 32px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 30px;
    letter-spacing: -0.5px;
    }

    .evaluado-info {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
    border-radius: 8px;
        padding: 16px 20px;
      margin-bottom: 30px;
        font-size: 15px;
        color: #374151;
    }

    .evaluado-info p {
     margin: 0;
    }

    .evaluado-info strong {
    color: #1f2937;
        font-weight: 600;
    }

  .progreso-section {
  background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px 20px;
        margin-bottom: 30px;
    }

    .contador-progreso {
        font-size: 14px;
        color: #6b7280;
      margin: 0 0 12px 0;
        font-weight: 500;
    }

    .barra-progreso {
     width: 100%;
      height: 8px;
    background: #e5e7eb;
        border-radius: 10px;
        overflow: hidden;
    }

    .barra-progreso-fill {
 height: 100%;
    background: #f58220;
        transition: width 0.3s ease;
  }

    .tarea-card {
    background: white;
   border: 1px solid #e5e7eb;
        border-radius: 12px;
      padding: 40px 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

    .pregunta-section {
      text-align: center;
    margin-bottom: 40px;
    }

  .contador-tareas {
   font-size: 18px;
 color: #1f2937;
        margin: 0;
      font-weight: 500;
        letter-spacing: 0.3px;
  }

  .instrumentos-section {
 margin-bottom: 40px;
      text-align: center;
    }

    .label-instrumento {
   display: block;
        font-size: 14px;
 font-weight: 600;
    color: #374151;
        margin-bottom: 12px;
    }

    .select-instrumento {
   width: 100%;
      max-width: 500px;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
    font-size: 14px;
 background: white;
        color: #374151;
        cursor: pointer;
        transition: all 0.3s ease;
  }

    .select-instrumento:focus {
        outline: none;
        border-color: #f58220;
  box-shadow: 0 0 0 3px rgba(245, 130, 32, 0.1);
    }

    .select-instrumento option {
  padding: 8px;
color: #374151;
        background: white;
    }

  .estrellas-container {
   display: flex;
        justify-content: center;
        gap: 20px;
      margin-bottom: 40px;
        flex-wrap: wrap;
}

    .estrella {
    width: 50px;
        height: 50px;
        font-size: 40px;
      border: 2px solid #d1d5db;
        background: white;
 color: #9ca3af;
     border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease;
      display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .estrella:hover {
        border-color: #f58220;
        color: #f58220;
        transform: scale(1.1);
    }

    .estrella.activa {
        background: #f58220;
        border-color: #f58220;
        color: white;
    }

    .descripcion-section {
      margin-bottom: 30px;
    }

    .label-descripcion {
      display: block;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
    margin-bottom: 12px;
    }

    .textarea-descripcion {
        width: 100%;
     min-height: 120px;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
border-radius: 8px;
   font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        resize: vertical;
        color: #374151;
    }

    .textarea-descripcion:focus {
        outline: none;
        border-color: #f58220;
  box-shadow: 0 0 0 3px rgba(245, 130, 32, 0.1);
    }

    .textarea-descripcion::placeholder {
        color: #9ca3af;
  }

    .botones-navegacion {
        display: flex;
  gap: 16px;
        justify-content: flex-end;
        margin-top: 40px;
     padding-top: 24px;
        border-top: 1px solid #e5e7eb;
    }

    .btn {
        padding: 12px 32px;
        border: none;
     border-radius: 24px;
        font-size: 16px;
        font-weight: 600;
    cursor: pointer;
      transition: all 0.3s ease;
        min-width: 140px;
    }

    .btn:disabled {
        opacity: 0.5;
   cursor: not-allowed;
    }

    .btn-siguiente {
        background: white;
        color: #f58220;
  border: 2px solid #f58220;
    }

    .btn-siguiente:hover:not(:disabled) {
        background: #f58220;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(245, 130, 32, 0.3);
    }

    .btn-listo {
        background: #f58220;
color: white;
    }

    .btn-listo:hover:not(:disabled) {
        background: #e67e1a;
        transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 130, 32, 0.3);
    }

    .alerta {
        max-width: 100%;
        margin: 0 0 20px 0;
        padding: 16px 20px;
        border-radius: 8px;
        display: flex;
     justify-content: space-between;
        align-items: center;
        animation: slideIn 0.3s ease-in-out;
    }

    .alerta-exito {
        background: #d1f4d1;
     border: 1px solid #6ee76e;
        color: #155724;
    }

    .alerta-error {
    background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .alerta-info {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
color: #004085;
}

    .btn-cerrar {
   background: none;
        border: none;
        font-size: 24px;
 cursor: pointer;
        color: inherit;
        padding: 0;
      margin-left: 20px;
    }

    .btn-cerrar:hover {
    opacity: 0.7;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
align-items: center;
        justify-content: center;
        padding: 60px 20px;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #e5e7eb;
        border-top-color: #f58220;
     border-radius: 50%;
   animation: spin 0.8s linear infinite;
        margin-bottom: 20px;
 }

    .loading-container p {
        color: #666;
        font-size: 16px;
    }

    @@keyframes slideIn {
        from {
opacity: 0;
   transform: translateY(-10px);
      }
        to {
            opacity: 1;
 transform: translateY(0);
        }
    }

    @@keyframes spin {
        to {
          transform: rotate(360deg);
        }
  }

    .resultado-evaluacion {
        display: flex;
      justify-content: center;
  align-items: center;
 min-height: 100vh;
   background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 20px;
    }

    .resultado-card {
  background: white;
        border-radius: 16px;
   padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        max-width: 600px;
        width: 100%;
    }

    .resultado-card.excelente {
        border-top: 5px solid #10b981;
    }

    .resultado-card.bien {
        border-top: 5px solid #3b82f6;
    }

    .resultado-card.reprobado {
        border-top: 5px solid #ef4444;
    }

    .resultado-header {
        text-align: center;
        margin-bottom: 30px;
    }

  .resultado-header h2 {
        font-size: 28px;
     color: #1f2937;
margin: 0;
        font-weight: 700;
    }

    .resultado-content {
        text-align: center;
    }

 .evaluado-resultado {
      margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e5e7eb;
    }

    .evaluado-resultado p {
        font-size: 16px;
   color: #6b7280;
        margin: 0;
    }

    .evaluado-resultado span {
    color: #1f2937;
        font-weight: 600;
        font-size: 18px;
    }

    .puntuacion-container {
        display: flex;
        align-items: center;
justify-content: center;
   gap: 30px;
        margin: 40px 0;
        flex-wrap: wrap;
    }

    .puntuacion-circulo {
        width: 150px;
        height: 150px;
   border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      font-weight: 700;
        color: white;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .puntuacion-circulo.excelente {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

    .puntuacion-circulo.bien {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .puntuacion-circulo.reprobado {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .puntuacion-numero {
        font-size: 48px;
        line-height: 1;
    }

    .puntuacion-maximo {
        font-size: 20px;
opacity: 0.9;
  margin-top: 5px;
    }

    .puntuacion-detalles {
        text-align: left;
        flex: 1;
     min-width: 200px;
    }

    .puntuacion-concepto {
        font-size: 22px;
        margin: 0 0 10px 0;
        color: #1f2937;
    }

    .puntuacion-concepto.excelente {
  color: #10b981;
    }

    .puntuacion-concepto.bien {
   color: #3b82f6;
    }

    .puntuacion-concepto.reprobado {
        color: #ef4444;
    }

  .puntuacion-descripcion {
 font-size: 14px;
   color: #6b7280;
      margin: 0;
    line-height: 1.6;
    }

    .resultado-resumen {
        background: #f9fafb;
        border-radius: 12px;
        padding: 24px;
 margin: 30px 0;
  border: 1px solid #e5e7eb;
    }

    .resumen-item {
        display: flex;
    justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .resumen-item:last-child {
        border-bottom: none;
    }

    .resumen-label {
        color: #6b7280;
        font-size: 14px;
  font-weight: 500;
    }

 .resumen-valor {
        color: #1f2937;
        font-size: 16px;
   font-weight: 700;
    }

    .resultado-botones {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 30px;
    }

  .btn-volver {
        background: #f58220;
        color: white;
      padding: 12px 32px;
        border: none;
        border-radius: 24px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
     min-width: 200px;
    }

    .btn-volver:hover {
     background: #e67e1a;
  transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(245, 130, 32, 0.3);
    }

    @@media (max-width: 768px) {
        .resultado-card {
            padding: 24px;
     }

     .resultado-header h2 {
          font-size: 22px;
   }

        .puntuacion-container {
   gap: 20px;
        }

    .puntuacion-circulo {
            width: 120px;
   height: 120px;
        }

 .puntuacion-numero {
        font-size: 40px;
        }

 .puntuacion-concepto {
        font-size: 18px;
 }

        .btn-volver {
            width: 100%;
        min-width: auto;
 }
    }

    @@media (max-width: 768px) {
      .container-evaluacion {
        padding: 20px;
        }

     .titulo-evaluacion {
     font-size: 24px;
 margin-bottom: 20px;
    }

  .tarea-card {
padding: 20px;
        }

    .estrellas-container {
  gap: 12px;
     }

    .estrella {
    width: 40px;
    height: 40px;
      font-size: 30px;
    }

  .botones-navegacion {
   flex-direction: column;
    gap: 12px;
      }

        .btn {
     width: 100%;
            min-width: auto;
        }
    }
</style>

@code {
    [Parameter]
    public int IdUsuario { get; set; }

    [Parameter]
    public string NombreUsuario { get; set; } = string.Empty;

    private EvaluacionPracticaModelo? modelo;
    private bool cargando = true;
    private bool cargandoSubmit = false;
    private bool mostrarMensaje = false;
    private bool mostrarResultado = false;
    private string mensajeRespuesta = string.Empty;
 private bool esError = false;
    private int indiceActual = 0;
    private int puntuacionFinal = 0;
    private string instrumentoSeleccionado = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CargarEvaluacion();
    }

    private async Task CargarEvaluacion()
  {
        try
        {
   cargando = true;
            // Crear evaluación de ejemplo con tareas
  modelo = new EvaluacionPracticaModelo
    {
        IdUsuario = IdUsuario,
  NombreUsuario = NombreUsuario,
       Tareas = new List<TareaPractica>
    {
        new TareaPractica { IdTarea = 1, Descripcion = "Tarea 1", Completada = false },
          new TareaPractica { IdTarea = 2, Descripcion = "Tarea 2", Completada = false },
      new TareaPractica { IdTarea = 3, Descripcion = "Tarea 3", Completada = false },
          new TareaPractica { IdTarea = 4, Descripcion = "Tarea 4", Completada = false },
    new TareaPractica { IdTarea = 5, Descripcion = "Tarea 5", Completada = false },
          new TareaPractica { IdTarea = 6, Descripcion = "Tarea 6", Completada = false },
      new TareaPractica { IdTarea = 7, Descripcion = "Tarea 7", Completada = false },
        new TareaPractica { IdTarea = 8, Descripcion = "Tarea 8", Completada = false },
           new TareaPractica { IdTarea = 9, Descripcion = "Tarea 9", Completada = false },
      new TareaPractica { IdTarea = 10, Descripcion = "Tarea 10", Completada = false }
     }
};
          indiceActual = 0;
      }
        catch (Exception ex)
    {
    mostrarMensaje = true;
      esError = true;
  mensajeRespuesta = $"Error al cargar la evaluación: {ex.Message}";
      Console.WriteLine($"Error: {ex.Message}");
        }
        finally
   {
  cargando = false;
        }
    }

    private void CalificarTarea(int calificacion)
    {
if (indiceActual < modelo?.Tareas?.Count)
      {
    modelo.Tareas[indiceActual].Calificacion = calificacion;
 }
    }

    private void IrASiguiente()
    {
        if (indiceActual < modelo?.Tareas?.Count - 1)
     {
  indiceActual++;
 instrumentoSeleccionado = string.Empty;
 }
    }

    private async Task Finalizar()
    {
        if (modelo == null) return;

   cargandoSubmit = true;
try
        {
// Validar que TODAS las tareas tengan calificación
var tareasSinCalificacion = modelo.Tareas
    .Where(t => !t.Calificacion.HasValue || t.Calificacion.Value <= 0)
 .ToList();

          if (tareasSinCalificacion.Count > 0)
 {
    mostrarMensaje = true;
    esError = true;
  mensajeRespuesta = $"Debe calificar todas las tareas. Faltan {tareasSinCalificacion.Count} por calificar.";
     cargandoSubmit = false;
     return;
          }

   // Calcular puntuación total
   var puntuacionTotal = modelo.Tareas
            .Where(t => t.Calificacion.HasValue)
       .Sum(t => t.Calificacion.Value);

    puntuacionFinal = (int)puntuacionTotal;

       var request = new
   {
   idUsuario = modelo.IdUsuario,
   nombreUsuario = modelo.NombreUsuario,
     tareas = modelo.Tareas.Select(t => new
 {
    idTarea = t.IdTarea,
  descripcion = t.Descripcion,
  resultadoObtenido = t.ResultadoObtenido,
  completada = t.Completada,
      calificacion = t.Calificacion
      }).ToList(),
      puntuacion = puntuacionTotal,
      recomendaciones = string.Join("\n", modelo.Tareas
        .Where(t => !string.IsNullOrWhiteSpace(t.ResultadoObtenido))
     .Select((t, i) => $"Tarea {i + 1}: {t.ResultadoObtenido}"))
 };
      var response = await Http.PostAsJsonAsync(
      "https://localhost:7287/api/evaluaciones/crear-evaluacion-practica",
      request
     );

      if (response.IsSuccessStatusCode)
 {
      mostrarMensaje = true;
     esError = false;
   mensajeRespuesta = $"¡Evaluación práctica guardada exitosamente!";
    
   // Redirigir después de 2 segundos a la lista de evaluaciones
       await Task.Delay(2000);
  NavigationManager.NavigateTo("/EvaluacionPracticaLista", forceLoad: true);
}
          else
   {
 var contenidoError = await response.Content.ReadAsStringAsync();
  mostrarMensaje = true;
   esError = true;
     mensajeRespuesta = $"Error al guardar: {response.StatusCode}";
  }
     }
 catch (Exception ex)
{
    mostrarMensaje = true;
   esError = true;
    mensajeRespuesta = $"Error: {ex.Message}";
        }
        finally
        {
     cargandoSubmit = false;
        }
 }

    private void CerrarMensaje()
    {
    mostrarMensaje = false;
    }
}
