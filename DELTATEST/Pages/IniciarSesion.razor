@page "/IniciarSesion"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@inject NavigationManager Navigation
@inject DELTATEST.Services.AuthService AuthService

<style>
/* Mantén tu CSS existente o pega el que uses */
.login-container { display:flex; align-items:center; justify-content:center; height:100vh; }
.login-box { width:400px; padding:40px; border:1px solid #e6e6e6; border-radius:8px; background:#fff; text-align:center; }
.btn-login { background:#e5a650; color:white; padding:10px; width:100%; border-radius:6px; border:none; cursor:pointer; }
.btn-login:hover { background:#cf923f; }
.form-group { text-align:left; margin-bottom:20px; }
.form-group label { display:block; margin-bottom:5px; }
.form-control { width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; }
.text-danger { color:#c00; margin-bottom:10px; }
</style>

<div class="login-container">
    <div class="login-box">
        <h1>INICIAR SESIÓN</h1>

        <EditForm EditContext="@editContext">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label>Usuario (CI o correo)</label>
                <InputText id="username" class="form-control" @bind-Value="model.Username" autocomplete="username" />
                <ValidationMessage For="@(() => model.Username)" />
            </div>

            <div class="form-group">
                <label>Contraseña</label>
                <InputText id="password" type="password" class="form-control" @bind-Value="model.Contrasena" autocomplete="current-password" />
                <ValidationMessage For="@(() => model.Contrasena)" />
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="text-danger">@errorMessage</div>
            }

            <!-- button type="button" para evitar submit nativo -->
            <button type="button" class="btn-login" @onclick="SubmitClick">Iniciar Sesión</button>
        </EditForm>
    </div>
</div>

@code {
    private DELTATEST.Models.LoginModel model = new();
    private EditContext editContext = default!;
    private string? errorMessage;

    protected override void OnInitialized()
    {
        editContext = new EditContext(model);
    }

    private async Task SubmitClick()
    {
        errorMessage = null;

        // Validación cliente
        if (!editContext.Validate())
        {
            errorMessage = editContext.GetValidationMessages().FirstOrDefault() ?? "Hay errores en el formulario.";
            StateHasChanged();
            return;
        }

        var (success, rol, message) = await AuthService.LoginAsync(model);

        if (success)
        {
            if (rol == "Inspector")
            {
                Navigation.NavigateTo("/panelControlAdmin", true);
            }
            else if (rol == "Evaluado")
            {
                Navigation.NavigateTo("/", true);
            }
            else
            {
                Navigation.NavigateTo("/", true);
            }

            return;
        }


    }


}