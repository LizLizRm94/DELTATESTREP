@page "/reporte-evaluacion/{IdEvaluacion:int}"
@using DELTATEST.Services
@inject ReporteEvaluacionService ReporteService
@inject NavigationManager Nav
@inject IJSRuntime JS

@if (isLoading)
{
    <div class="text-center p-5">
        <div class="spinner-border text-warning" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3">Cargando reporte de evaluación...</p>
    </div>
}
else if (evaluacion != null)
{
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold text-warning">Reporte de Evaluación</h3>
            <div class="gap-2">
                <button class="btn btn-primary" @onclick="ImprimirReporte" title="Imprimir o descargar como PDF">
                    <i class="bi bi-printer"></i> Imprimir/Descargar
                </button>
                <button class="btn btn-secondary" @onclick="IrAtras">
                    <i class="bi bi-arrow-left"></i> Volver
                </button>
            </div>
        </div>
        
        @((MarkupString)htmlReporte)
    </div>
}
else
{
    <div class="alert alert-danger text-center m-5">
        <h4>Error al cargar la evaluación</h4>
        <p>No se encontró la evaluación solicitada.</p>
        <button class="btn btn-warning" @onclick="IrAtras">Volver</button>
    </div>
}

@code {
    [Parameter]
    public int IdEvaluacion { get; set; }

    private DetalleEvaluacionDto? evaluacion;
    private string htmlReporte = string.Empty;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            evaluacion = await ReporteService.ObtenerEvaluacionAsync(IdEvaluacion);
            if (evaluacion != null)
            {
                htmlReporte = ReporteService.GenerarHtmlReporte(evaluacion);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ImprimirReporte()
    {
        await JS.InvokeVoidAsync("window.print");
    }

    private void IrAtras()
    {
        Nav.NavigateTo("/verEvaluacionesReportes");
    }
}
