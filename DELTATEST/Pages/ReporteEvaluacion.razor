@page "/reporte-evaluacion/{IdEvaluacion:int}"
@using DELTATEST.Services
@layout ReportePrintLayout
@inject ReporteEvaluacionService ReporteService
@inject NavigationManager Nav
@inject IJSRuntime JS

@if (isLoading)
{
    <div class="text-center p-5">
        <div class="spinner-border text-warning" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3">Cargando reporte de evaluación...</p>
    </div>
}
else if (evaluacion != null && !string.IsNullOrEmpty(htmlReporte))
{
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4 no-print">
            <h3 class="fw-bold text-warning">Reporte de Evaluación</h3>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" @onclick="ImprimirReporte" title="Imprimir o descargar como PDF">
                    <i class="bi bi-printer"></i> Imprimir/Descargar
                </button>
                <button class="btn btn-secondary" @onclick="IrAtras">
                    <i class="bi bi-arrow-left"></i> Volver
                </button>
            </div>
        </div>
        
        @((MarkupString)htmlReporte)
    </div>
}
else if (loadError)
{
    <div class="alert alert-danger text-center m-5">
        <h4>Error al cargar la evaluación</h4>
        <p>@errorMessage</p>
        <button class="btn btn-warning" @onclick="IrAtras">Volver</button>
    </div>
}
else
{
    <div class="alert alert-danger text-center m-5">
        <h4>Error al cargar la evaluación</h4>
        <p>No se encontró la evaluación solicitada o hubo un error al generar el reporte.</p>
        <button class="btn btn-warning" @onclick="IrAtras">Volver</button>
    </div>
}

<style>
    @@media print {
        .no-print {
            display: none !important;
        }
        
        body {
            margin: 0;
            padding: 0;
        }
        
        .container-fluid {
            max-width: 100%;
            padding: 0;
        }
    }
</style>

@code {
    [Parameter]
    public int IdEvaluacion { get; set; }

    private DetalleEvaluacionDto? evaluacion;
    private string htmlReporte = string.Empty;
    private bool isLoading = true;
    private bool loadError = false;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Console.WriteLine($"ReporteEvaluacion - Loading evaluation ID: {IdEvaluacion}");
            isLoading = true;
            loadError = false;
            errorMessage = string.Empty;
            
            // Add a small delay to ensure component is fully initialized
            await Task.Delay(50);
            
            evaluacion = await ReporteService.ObtenerEvaluacionAsync(IdEvaluacion);
            
            if (evaluacion != null)
            {
                Console.WriteLine($"ReporteEvaluacion - Evaluation loaded successfully");
                try
                {
                    htmlReporte = ReporteService.GenerarHtmlReporte(evaluacion);
                    if (string.IsNullOrEmpty(htmlReporte))
                    {
                        Console.WriteLine($"ReporteEvaluacion - HTML generation returned empty");
                        loadError = true;
                        errorMessage = "El reporte no pudo ser generado correctamente.";
                    }
                }
                catch (Exception exHtml)
                {
                    Console.WriteLine($"ReporteEvaluacion - HTML generation error: {exHtml.Message}");
                    loadError = true;
                    errorMessage = $"Error al generar el HTML: {exHtml.Message}";
                }
            }
            else
            {
                Console.WriteLine($"ReporteEvaluacion - Failed to load evaluation, service returned null");
                loadError = true;
                errorMessage = "No se pudo cargar la información de la evaluación.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ReporteEvaluacion - Error: {ex.Message}");
            Console.WriteLine($"ReporteEvaluacion - StackTrace: {ex.StackTrace}");
            loadError = true;
            errorMessage = $"Error al cargar la evaluación: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ImprimirReporte()
    {
        try
        {
            await JS.InvokeVoidAsync("window.print");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ReporteEvaluacion - Print error: {ex.Message}");
        }
    }

    private void IrAtras()
    {
        try
        {
            Nav.NavigateTo("/admin/evaluaciones-teoricas");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ReporteEvaluacion - Navigation error: {ex.Message}");
            Nav.NavigateTo("/");
        }
    }
}
