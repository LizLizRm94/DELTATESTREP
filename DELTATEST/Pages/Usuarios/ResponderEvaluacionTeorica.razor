@page "/responder-evaluacion-teorica/{IdEvaluacion:int}"
@using DELTATEST.Models
@using System.Text.Json
@inject HttpClient Http
@inject NavigationManager NavigationManager
@layout MainSinLayout

<div class="container-responder">
    <h2 class="titulo-evaluacion">RESPONDER EVALUACIÓN TEÓRICA</h2>

   @if (cargando)
   {
      <div class="loading">
           <div class="spinner"></div>
   <p>Cargando evaluación...</p>
       </div>
   }
  else if (mostrarError)
    {
       <div class="alerta alerta-error">
          <span>@mensajeError</span>
    </div>
    }
    else if (!finalizado)
   {
      <form @onsubmit="SubmitRespuestas">
            <div class="preguntas-container">

           <!-- SECCIÓN 1: Preguntas Abiertas -->
      @if (preguntasAbiertas != null && preguntasAbiertas.Count > 0)
       {
     <div class="seccion">
       <h3 class="titulo-seccion">Preguntas Abiertas</h3>

    @foreach (var pregunta in preguntasAbiertas)
       {
  var respuesta = respuestas.FirstOrDefault(r => r.IdPregunta == pregunta.IdPregunta);

     <div class="pregunta-abierta">
      <div class="pregunta-titulo">
           <span class="numero-pregunta">@(preguntasAbiertas.IndexOf(pregunta) + 1)</span>
  <p>@pregunta.Texto</p>
      <span class="puntos-badge">@pregunta.Puntos puntos</span>
       </div>
   <textarea class="textarea-respuesta"
      @bind="respuesta.TextoRespuesta"
         placeholder="Escriba su respuesta aquí..."
       required></textarea>
            </div>
         }
      </div>
      }

             <!-- SECCIÓN 2: Preguntas Múltiple -->
       @if (preguntasMultiples != null && preguntasMultiples.Count > 0)
 {
      <div class="seccion">
   <h3 class="titulo-seccion">Preguntas de Opción Múltiple</h3>

         @foreach (var pregunta in preguntasMultiples)
      {
       var respuesta = respuestas.FirstOrDefault(r => r.IdPregunta == pregunta.IdPregunta);
      var opciones = JsonSerializer.Deserialize<List<Dictionary<string, object>>>(pregunta.Opciones ?? "[]") ?? new List<Dictionary<string, object>>();

          <div class="pregunta-multiple">
    <div class="pregunta-titulo">
 <span class="numero-pregunta">@(preguntasMultiples.IndexOf(pregunta) + 1)</span>
     <p>@pregunta.Texto</p>
      <span class="puntos-badge">@pregunta.Puntos puntos</span>
      </div>

 <div class="opciones-respuesta">
     @foreach (var opcion in opciones)
   {
     var indexOpcion = opciones.IndexOf(opcion);
   var textoOpcion = opcion.ContainsKey("texto") ? opcion["texto"].ToString() : "";
      var opcionId = $"opcion_{pregunta.IdPregunta}_{indexOpcion}";

     <div class="opcion-respuesta">
      <input type="radio"
          id="@opcionId"
            name="pregunta_@pregunta.IdPregunta"
    value="@indexOpcion"
      @onchange="@((ChangeEventArgs e) => SeleccionarOpcion(respuesta, e.Value?.ToString() ?? ""))"
 checked="@(respuesta?.TextoRespuesta == indexOpcion.ToString())" />
     <label for="@opcionId" class="label-opcion">
      <span class="letra-opcion">@((char)('A' + indexOpcion))</span>
  <span class="texto-opcion">@textoOpcion</span>
</label>
 </div>
  }
   </div>
   </div>
        }
  </div>
   }

     </div>

      <div class="botones-responder">
    <button type="submit" class="btn btn-enviar" disabled="@enviando">
         @if (enviando)
    {
      <span>Enviando...</span>
 }
    else
       {
          <span>Enviar Respuestas</span>
  }
      </button>
  <button type="button" class="btn btn-volver" @onclick="Volver">Volver</button>
       </div>
   </form>
    }
 else
    {
      <div class="mensaje-finalizado">
         <div class="icono-exito">?</div>
  <h3>¡Respuestas Enviadas!</h3>
    <p>Tu evaluación ha sido registrada correctamente.</p>
     <button class="btn btn-volver" @onclick="Volver">Volver a Evaluaciones</button>
      </div>
  }
 </div>

@code {
    [Parameter]
    public int IdEvaluacion { get; set; }

   private List<PreguntaDto> preguntasAbiertas = new();
   private List<PreguntaDto> preguntasMultiples = new();
  private List<RespuestaDto> respuestas = new();
  private bool cargando = true;
  private bool enviando = false;
  private bool mostrarError = false;
    private string mensajeError = "";
   private bool finalizado = false;

  protected override async Task OnInitializedAsync()
    {
     await CargarEvaluacion();
   }

  private async Task CargarEvaluacion()
 {
    try
        {
          cargando = true;

       // Obtener preguntas
         var responsePreg = await Http.GetAsync($"api/preguntas/evaluacion/{IdEvaluacion}");
           if (responsePreg.IsSuccessStatusCode)
 {
         var preguntas = await responsePreg.Content.ReadFromJsonAsync<List<PreguntaDto>>();
  if (preguntas != null)
   {
     preguntasAbiertas = preguntas.Where(p => p.TipoEvaluacion).ToList();
      preguntasMultiples = preguntas.Where(p => !p.TipoEvaluacion).ToList();

        // Inicializar respuestas
        respuestas = preguntas.Select(p => new RespuestaDto
      {
       IdPregunta = p.IdPregunta,
           TextoRespuesta = string.Empty
  }).ToList();
  }
            }
   else
      {
       mostrarError = true;
 mensajeError = "No se pudieron cargar las preguntas";
      }
    }
    catch (Exception ex)
  {
      Console.WriteLine($"Error: {ex.Message}");
        mostrarError = true;
   mensajeError = "Error al cargar la evaluación";
    }
      finally
 {
   cargando = false;
   }
   }

  private void SeleccionarOpcion(RespuestaDto respuesta, string indiceOpcion)
   {
      respuesta.TextoRespuesta = indiceOpcion;
    }

  private async Task SubmitRespuestas()
   {
    // Validar que todas las preguntas tengan respuesta
   var preguntasSinRespuesta = respuestas.Where(r => string.IsNullOrWhiteSpace(r.TextoRespuesta)).ToList();
      if (preguntasSinRespuesta.Count > 0)
     {
    mostrarError = true;
    mensajeError = $"Debe responder todas las preguntas. Faltan {preguntasSinRespuesta.Count}";
         return;
   }

       enviando = true;
      try
     {
     var request = new
  {
      idEvaluacion = IdEvaluacion,
           respuestas = respuestas.Select(r => new
         {
       idPregunta = r.IdPregunta,
          textoRespuesta = r.TextoRespuesta
      }).ToList()
};

    var response = await Http.PostAsJsonAsync("api/respuestas/guardar", request);

       if (response.IsSuccessStatusCode)
      {
        finalizado = true;
      }
 else
      {
      mostrarError = true;
      mensajeError = "Error al guardar las respuestas";
         }
    }
   catch (Exception ex)
  {
   mostrarError = true;
      mensajeError = $"Error: {ex.Message}";
       }
  finally
 {
   enviando = false;
 }
   }

   private void Volver()
   {
    NavigationManager.NavigateTo("/usuarios/evaluaciones/1");
    }

    // DTOs
  public class PreguntaDto
  {
   public int IdPregunta { get; set; }
     public string Texto { get; set; }
 public bool TipoEvaluacion { get; set; }
      public string Opciones { get; set; }
      public int Puntos { get; set; } = 0;
    }

    public class RespuestaDto
  {
    public int IdPregunta { get; set; }
       public string TextoRespuesta { get; set; } = string.Empty;
    }
}

<style>
    .container-responder {
   max-width: 800px;
      margin: 0 auto;
        padding: 40px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-top: 60px;
    }

    .titulo-evaluacion {
        text-align: center;
        font-size: 28px;
        font-weight: 700;
        color: #333;
        margin-bottom: 40px;
    }

    .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100px;
        margin-bottom: 40px;
    }

    .spinner {
        width: 36px;
        height: 36px;
        border: 4px solid #e5e7eb;
        border-top-color: #f58220;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-bottom: 12px;
    }

    .alerta {
        max-width: 100%;
  margin: 0 0 20px 0;
        padding: 16px 20px;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
     animation: slideIn 0.3s ease-in-out;
    }

    .alerta-exito {
        background: #d1f4d1;
        border: 1px solid #6ee76e;
 color: #155724;
  }

    .alerta-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .titulo-seccion {
        font-size: 22px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 16px;
    }

    .preguntas-container {
        margin-bottom: 40px;
    }

    .pregunta-abierta {
        margin-bottom: 28px;
        padding: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #f9fafb;
    }

    .pregunta-titulo {
        margin-bottom: 12px;
   font-size: 16px;
    font-weight: 500;
     color: #111;
    }

    .puntos-badge {
        display: inline-block;
        background: linear-gradient(135deg, #f58220, #f5a020);
        color: white;
        padding: 4px 12px;
     border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    margin-left: 12px;
        white-space: nowrap;
    }

    .textarea-respuesta {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        color: #374151;
resize: vertical;
        min-height: 100px;
    }

    .textarea-respuesta:focus {
      outline: none;
border-color: #f58220;
    box-shadow: 0 0 0 3px rgba(245, 130, 32, 0.1);
    }

    .textarea-respuesta::placeholder {
        color: #9ca3af;
    }

    .pregunta-multiple {
        margin-bottom: 28px;
        padding: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #f9fafb;
    }

    .opciones-respuesta {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .opcion-respuesta {
        display: flex;
        align-items: center;
        cursor: pointer;
    }

    .opcion-respuesta input {
        display: none;
    }

    .label-opcion {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background: white;
        font-size: 14px;
        color: #374151;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }

    .letra-opcion {
        font-weight: 600;
        margin-right: 8px;
    }

    .texto-opcion {
        flex: 1;
    }

    .label-opcion:before {
        content: '';
        position: absolute;
        top: 50%;
        left: 12px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #f58220;
        transform: translateY(-50%) scale(0);
        transition: all 0.3s ease;
    }

    .opcion-respuesta input:checked + .label-opcion {
        background: #f58220;
        color: white;
        border-color: #f58220;
    }

    .opcion-respuesta input:checked + .label-opcion:before {
        transform: translateY(-50%) scale(1);
    }

    .botones-responder {
        display: flex;
        justify-content: space-between;
        margin-top: 32px;
    }

    .btn {
    padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-enviar {
        background: #f58220;
        color: white;
    }

    .btn-enviar:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-volver {
        background: #e5e7eb;
        color: #111;
    }

    .btn-volver:hover {
        background: #d1d5db;
    }

    .mensaje-finalizado {
        text-align: center;
        padding: 40px 20px;
        background: #d1e7dd;
        border-radius: 12px;
        margin-top: 40px;
    }

    .icono-exito {
        font-size: 48px;
        color: #198754;
        margin-bottom: 16px;
    }

    @@keyframes slideIn {
        from {
         opacity: 0;
    transform: translateY(-10px);
        }
        to {
            opacity: 1;
        transform: translateY(0);
        }
    }

    @@keyframes spin {
    to {
         transform: rotate(360deg);
        }
    }

  @@media (max-width: 768px) {
        .container-responder {
  padding: 20px;
   }

        .titulo-evaluacion {
            font-size: 24px;
   margin-bottom: 20px;
        }

      .botones-responder {
            flex-direction: column;
  gap: 12px;
        }
    }
</style>
