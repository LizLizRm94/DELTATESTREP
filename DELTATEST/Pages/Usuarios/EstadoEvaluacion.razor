@page "/estado/{IdUsuario:int}"
@using DELTATEST.Models
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@layout MainSinLayout

@if (cargando)
{
    <div class="text-center mt-5">
        <p>Cargando estado del usuario...</p>
    </div>
}
else
{

    <h2 class="text-center text-orange text-uppercase mb-4">Mi estado de evaluación</h2>

    <h2 class="text-center text-dark mb-2">Panel de Usuario</h2>
    

    <!-- BIENVENIDA CENTRADA -->
    <p class="text-center text-dark mb-5 h5">Bienvenido <span class="text-warning fw-bold">@(!string.IsNullOrWhiteSpace(nombreUsuario) ? nombreUsuario : "Usuario")</span></p>

    <div class="row">
    <div class="col-md-6 d-flex flex-column align-items-center">
            <div class="d-flex flex-column align-items-center w-100" style="max-width: 420px;">
      
      <!-- CUADRO DE ÚLTIMA NOTA ENTREGADA CON ESTILO NARANJA INTENSO -->
      @if (ultimaEvaluacion != null)
      {
          <div class="card shadow-lg border-0 w-100" style="background: linear-gradient(135deg, #f58220 0%, #ff9c42 100%); color: white; margin-bottom: 20px;">
              <div class="card-body text-center p-5">
                  <h5 class="card-title mb-4" style="font-size: 18px; font-weight: 600; letter-spacing: 0.5px;">Última Nota Entregada</h5>
                  <div class="mb-3">
                      <p style="font-size: 72px; font-weight: bold; margin: 0; line-height: 1;">
                          @(ultimaEvaluacion.Nota.HasValue ? ultimaEvaluacion.Nota.Value.ToString("F0") : "N/A")
                          <span style="font-size: 36px;">/ 100</span>
                      </p>
                  </div>
                  <hr style="background-color: rgba(255,255,255,0.3); margin: 20px 0;">
                  <div class="row">
                      <div class="col-6">
                          <p style="font-size: 12px; opacity: 0.9; margin-bottom: 5px; font-weight: 500;">Fecha</p>
                          <p style="font-weight: bold; font-size: 16px;">@ultimaEvaluacion.FechaEvaluacion?.ToString("dd/MM/yyyy")</p>
                      </div>
                      <div class="col-6">
                          <p style="font-size: 12px; opacity: 0.9; margin-bottom: 5px; font-weight: 500;">Estado</p>
                          <p style="font-weight: bold; font-size: 16px;">@(ultimaEvaluacion.Nota.HasValue ? "Calificado" : "Pendiente")</p>
                      </div>
                  </div>
              </div>
          </div>
      }
      
    <button class="btn btn-orange mt-1" @onclick="VerEvaluaciones">
  Ver Evaluaciones
   </button>
            </div>
        </div>

        <!-- DERECHA: NOTIFICACIONES -->
        <div class="col-md-6">
            <h4 class="mb-3 text-orange text-center">Notificaciones</h4>
 @if (notificaciones != null && notificaciones.Count > 0)
            {
        <ul class="list-group">
        @foreach (var n in notificaciones)
  {
            <li class="list-group-item">
       <strong>@n.TipoNotificacion:</strong> @n.Mensaje
            <div class="small text-muted">
   @(n.FechaEnvio?.ToString("dd/MM/yyyy HH:mm") ?? "Sin fecha")
  </div>
         </li>
     }
          </ul>
            }
   else
 {
              <div class="alert alert-info text-center">No tienes notificaciones nuevas.</div>
     }
      </div>
    </div>
}

@code {
    [Parameter]
    public int IdUsuario { get; set; }

    private string nombreUsuario = "Usuario";
    private UltimaEvaluacion? ultimaEvaluacion;
    private List<NotificacionSimple>? notificaciones = new();
    private bool cargando = true;

    private class NotificacionSimple
    {
        public string TipoNotificacion { get; set; } = string.Empty;
        public string Mensaje { get; set; } = string.Empty;
        public DateTime? FechaEnvio { get; set; }
    }

    private class UltimaEvaluacion
    {
        public int IdEvaluacion { get; set; }
        public DateOnly? FechaEvaluacion { get; set; }
        public decimal? Nota { get; set; }
        public string? TipoEvaluacion { get; set; }
    }

    private class EvaluacionPractica
    {
        public int IdEvaluacion { get; set; }
        public DateOnly? FechaEvaluacion { get; set; }
        public decimal? NotaPractica { get; set; }
    }

    private class EvaluacionTeorica
    {
        public int IdEvaluacion { get; set; }
        public DateOnly? FechaEvaluacion { get; set; }
        public decimal? Nota { get; set; }
        public string? EstadoEvaluacion { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarEstado();
    }

    private async Task CargarEstado()
    {
        try
        {
            cargando = true;

            // 1. Obtener nombre del usuario
            try
            {
                nombreUsuario = await LocalStorage.GetItemAsync<string>("userName") ?? "Usuario";
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al cargar nombre: {ex.Message}");
                nombreUsuario = "Usuario";
            }

            // 2. Obtener última evaluación PRÁCTICA
            try
            {
                var evalsResponse = await Http.GetAsync($"api/evaluaciones/usuario/{IdUsuario}");
                if (evalsResponse.IsSuccessStatusCode)
                {
                    var evals = await evalsResponse.Content.ReadFromJsonAsync<List<EvaluacionPractica>>();
                    if (evals != null && evals.Count > 0)
                    {
                        // Obtener la más reciente (última)
                        var ultima = evals.OrderByDescending(e => e.FechaEvaluacion).FirstOrDefault();
                        if (ultima != null && ultima.NotaPractica.HasValue)
                        {
                            ultimaEvaluacion = new UltimaEvaluacion
                            {
                                IdEvaluacion = ultima.IdEvaluacion,
                                FechaEvaluacion = ultima.FechaEvaluacion,
                                Nota = ultima.NotaPractica,
                                TipoEvaluacion = "Práctica"
                            };
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error obteniendo evaluación práctica: {ex.Message}");
            }

            // 3. Si no hay evaluación práctica con nota, obtener evaluación TEÓRICA
            if (ultimaEvaluacion == null)
            {
                try
                {
                    var teoricaResponse = await Http.GetAsync($"api/evaluacionesteoricass/usuario/{IdUsuario}");
                    if (teoricaResponse.IsSuccessStatusCode)
                    {
                        var evals = await teoricaResponse.Content.ReadFromJsonAsync<List<EvaluacionTeorica>>();
                        if (evals != null && evals.Count > 0)
                        {
                            // Obtener la más reciente con nota
                            var ultima = evals.Where(e => e.Nota.HasValue)
                                .OrderByDescending(e => e.FechaEvaluacion)
                                .FirstOrDefault();
                            
                            if (ultima != null)
                            {
                                ultimaEvaluacion = new UltimaEvaluacion
                                {
                                    IdEvaluacion = ultima.IdEvaluacion,
                                    FechaEvaluacion = ultima.FechaEvaluacion,
                                    Nota = ultima.Nota,
                                    TipoEvaluacion = "Teórica"
                                };
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error obteniendo evaluación teórica: {ex.Message}");
                }
            }

            // 4. Obtener notificaciones
            try
            {
                var notifResponse = await Http.GetAsync($"api/notificaciones/usuario/{IdUsuario}");
                if (notifResponse.IsSuccessStatusCode)
                {
                    notificaciones = await notifResponse.Content.ReadFromJsonAsync<List<NotificacionSimple>>();
                }
                else
                {
                    notificaciones = new List<NotificacionSimple>();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Advertencia notificaciones: {ex.Message}");
                notificaciones = new List<NotificacionSimple>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error general: {ex.Message}");
        }
        finally
        {
            cargando = false;
        }
    }

    private void VerEvaluaciones()
    {
        NavigationManager.NavigateTo($"/usuarios/evaluaciones/{IdUsuario}");
    }
}
